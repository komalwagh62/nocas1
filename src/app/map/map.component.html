<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenLayers Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v6.15.1/css/ol.css" type="text/css">
    <script src="https://openlayers.org/en/v6.15.1/build/ol.js" type="text/javascript"></script>
    <style>
        #map {
            width: 100%;
            height: 80vh;
        }
        #feature-info {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <form>
        <label for="track_magnetic">Track Magnetic:</label>
        <input type="text" id="track_magnetic" oninput="filterAndShowFeatures();">
    </form>
    <div id="map" class="map"></div>
    <div id="feature-info"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof ol === 'undefined') {
                console.error('OpenLayers library failed to load.');
                return;
            }

            var map = new ol.Map({
                view: new ol.View({
                    center: [0, 0],
                    zoom: 2
                }),
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                target: 'map'
            });

            var vectorLayer; // Define vectorLayer globally for reuse

            // Function to add GeoJSON data to the map
            function addGeoJSONToMap(geojson) {
                var vectorSource = new ol.source.Vector({
                    features: new ol.format.GeoJSON().readFeatures(geojson, {
                        featureProjection: 'EPSG:3857'
                    })
                });

                vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                });

                map.addLayer(vectorLayer);

                // Fit the map view to the extent of the GeoJSON data
                map.getView().fit(vectorSource.getExtent(), {
                    padding: [50, 50, 50, 50],
                    maxZoom: 15
                });

                // Add click event listener to the map
                map.on('click', function(event) {
                    displayFeatureInfo(event.pixel);
                });
            }

            // Fetch initial GeoJSON data from the server
            fetch('http://localhost:3005/data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data); // Log the fetched data
                    addGeoJSONToMap(data); // Add GeoJSON data to the map initially
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });

            // Function to filter and show features based on track_magnetic value
            window.filterAndShowFeatures = function() {
                var trackMagnetic = document.getElementById('track_magnetic').value.toLowerCase();

                // Remove existing vectorLayer from the map
                if (vectorLayer) {
                    map.removeLayer(vectorLayer);
                }

                // Check if trackMagnetic is empty
                if (trackMagnetic === "") {
                    // Reload entire GeoJSON data to the map
                    fetch('http://localhost:3005/data')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            addGeoJSONToMap(data); // Add GeoJSON data to the map
                        })
                        .catch(error => {
                            console.error('Error fetching data:', error);
                        });
                } else {
                    var filteredFeatures = [];

                    // Fetch GeoJSON data filtered by trackMagnetic value
                    fetch('http://localhost:3005/data?track_magnetic=' + trackMagnetic)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Add filtered GeoJSON data to the map
                            addGeoJSONToMap(data);

                            // Highlight matching features
                            vectorLayer.getSource().getFeatures().forEach(function(feature) {
                                var properties = feature.getProperties();
                                var featureTrackMagnetic = properties['track_magnetic'].toString().toLowerCase();

                                // Case-insensitive comparison for track_magnetic value
                                if (featureTrackMagnetic === trackMagnetic) {
                                    feature.setStyle(new ol.style.Style({
                                        stroke: new ol.style.Stroke({
                                            color: 'rgba(255, 0, 0, 1)', // Red color for stroke
                                            width: 2 // Stroke width
                                        }),
                                        fill: new ol.style.Fill({
                                            color: 'rgba(255, 0, 0, 0.2)' // Light red fill color
                                        })
                                    }));
                                    filteredFeatures.push(feature); // Add matching feature to filtered list
                                } else {
                                    feature.setStyle(null); // Reset style if not matching
                                }
                            });

                            // Update vector layer with filtered features
                            vectorLayer.setSource(new ol.source.Vector({
                                features: filteredFeatures
                            }));

                            // Fit the map view to the extent of the filtered features
                            map.getView().fit(vectorLayer.getSource().getExtent(), {
                                padding: [50, 50, 50, 50],
                                maxZoom: 15
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching filtered data:', error);
                        });
                }
            };

            // Function to display feature information
            function displayFeatureInfo(pixel) {
                var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                    return feature;
                });

                if (feature) {
                    var properties = feature.getProperties();
                    var info = '<h3>Feature Info</h3>';
                    for (var prop in properties) {
                        if (properties.hasOwnProperty(prop)) {
                            info += '<strong>' + prop + ':</strong> ' + properties[prop] + '<br>';
                        }
                    }
                    document.getElementById('feature-info').innerHTML = info;
                } else {
                    document.getElementById('feature-info').innerHTML = '';
                }
            }
        });
    </script>
</body>
</html>
